(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[130],{13436:function(e,t,r){Promise.resolve().then(r.bind(r,70921))},70921:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return N}});var a=r(57437),n=r(2265),i=r(11713),s=r(84286),o=r(28124),l=r(42488),c=r(40476),d=r(66070);function u(e){let{title:t,value:r,subtitle:n,dataTour:i}=e;return(0,a.jsxs)(d.Zb,{className:"flex flex-col gap-1","data-tour":i,children:[(0,a.jsx)(d.SZ,{children:t}),(0,a.jsx)(d.ll,{className:"text-xl",children:r}),(0,a.jsx)("p",{className:"text-xs text-muted",children:n})]})}var m=r(47625),h=r(48508),p=r(56940),g=r(97059),f=r(62994),x=r(8147),b=r(83046),v=r(58772);function y(e){let{data:t,dataTour:r}=e,i=(0,n.useMemo)(()=>t.map((e,t)=>{var r;return{...e,label:"S".concat(null!==(r=e.segment)&&void 0!==r?r:t+1)}}).sort((e,t)=>t.customers-e.customers),[t]),s=(0,n.useMemo)(()=>i.reduce((e,t)=>{var r;return e+(null!==(r=t.customers)&&void 0!==r?r:0)},0),[i]);return(0,a.jsxs)(d.Zb,{className:"h-full","data-tour":r,children:[(0,a.jsxs)("div",{className:"mb-4 flex items-center justify-between gap-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(d.ll,{children:"Active Segment Distribution"}),(0,a.jsx)("p",{className:"text-xs text-muted",children:i.length?"".concat(i.length," segments \xb7 ").concat(s.toLocaleString()," customers"):"No segments yet"})]}),(0,a.jsx)("div",{className:"rounded-full border border-panelBorder bg-panel px-3 py-1 text-xs text-muted",children:"Updated live"})]}),(0,a.jsx)("div",{className:"h-64",children:0===i.length?(0,a.jsx)("div",{className:"flex h-full items-center justify-center rounded-xl border border-dashed border-panelBorder bg-background text-sm text-muted",children:"Waiting for segment data"}):(0,a.jsx)(m.h,{width:"100%",height:"100%",children:(0,a.jsxs)(h.v,{data:i,margin:{top:8,right:12,left:4,bottom:8},children:[(0,a.jsx)("defs",{children:(0,a.jsxs)("linearGradient",{id:"segmentBar",x1:"0",y1:"0",x2:"0",y2:"1",children:[(0,a.jsx)("stop",{offset:"0%",stopColor:"rgb(var(--color-accent))",stopOpacity:.95}),(0,a.jsx)("stop",{offset:"100%",stopColor:"rgb(var(--color-accent))",stopOpacity:.55})]})}),(0,a.jsx)(p.q,{stroke:"rgba(255,255,255,0.06)",strokeDasharray:"4 6",vertical:!1}),(0,a.jsx)(g.K,{dataKey:"label",tick:{fill:"rgb(var(--color-muted))",fontSize:11},axisLine:!1,tickLine:!1}),(0,a.jsx)(f.B,{tick:{fill:"rgb(var(--color-muted))",fontSize:11},axisLine:!1,tickLine:!1,width:30}),(0,a.jsx)(x.u,{cursor:{fill:"rgba(255,255,255,0.04)"},contentStyle:{background:"rgb(var(--color-panel))",border:"1px solid rgb(var(--color-panel-border))",color:"rgb(var(--color-text))",borderRadius:"12px",boxShadow:"0 14px 30px rgba(0,0,0,0.28)"},labelStyle:{color:"rgb(var(--color-muted))"}}),(0,a.jsx)(b.$,{dataKey:"customers",fill:"url(#segmentBar)",radius:[10,10,4,4],maxBarSize:42,children:(0,a.jsx)(v.e,{dataKey:"customers",position:"top",formatter:e=>e.toLocaleString(),fill:"rgb(var(--color-text))",fontSize:11})})]})})})]})}var j=r(15883);function N(){var e,t,r,m,h,p;let g=(0,i.a)({queryKey:["health"],queryFn:j.h.health,refetchInterval:5e3}),f=(0,i.a)({queryKey:["metrics"],queryFn:j.h.metrics,retry:!1,refetchInterval:5e3}),x=(0,i.a)({queryKey:["segments"],queryFn:j.h.segments,retry:!1,refetchInterval:5e3}),b=(0,i.a)({queryKey:["predictions"],queryFn:j.h.predictions,retry:!1,refetchInterval:5e3}),v=null!==(h=null===(e=x.data)||void 0===e?void 0:e.map(e=>({segment:e.segment,customers:e.customers})))&&void 0!==h?h:[],N=(0,n.useMemo)(()=>{var e;let t=null!==(e=f.data)&&void 0!==e?e:{},r=t.logreg_acc,a=t.xgb_acc,n=t.logreg_best_threshold,i=t.xgb_best_threshold;if("number"==typeof r&&"number"==typeof a){if(r>=a&&"number"==typeof n)return n;if("number"==typeof i)return i}return"number"==typeof n?n:"number"==typeof i?i:.7},[f.data]),S=(0,n.useMemo)(()=>{var e;let t=null!==(e=b.data)&&void 0!==e?e:[],r=0,a=0,n=0,i=0,s=0;return t.forEach(e=>{let t=e.result;if(null==t?void 0:t.rows)t.rows.forEach(e=>{var t,i;r+=1;let o=Number(null!==(t=e.churn_probability)&&void 0!==t?t:0),l=Number(null!==(i=e.ltv_estimate)&&void 0!==i?i:0);o>=N&&(a+=1),l>=1e3&&(n+=1),s+=o});else if((null==t?void 0:t.churn_probability)!==void 0){var i,o;r+=1;let e=Number(null!==(i=t.churn_probability)&&void 0!==i?i:0),l=Number(null!==(o=t.ltv_estimate)&&void 0!==o?o:0);e>=N&&(a+=1),l>=1e3&&(n+=1),s+=e}}),i=r>0?s/r:0,{total:r,highRisk:a,highValue:n,avgChurn:i}},[b.data,N]);return(0,a.jsxs)("div",{className:"grid gap-4",children:[(0,a.jsxs)("div",{className:"grid gap-3 md:grid-cols-2 lg:grid-cols-4",children:[(0,a.jsx)(u,{title:"System Health",value:null!==(p=null===(t=g.data)||void 0===t?void 0:t.status)&&void 0!==p?p:"—",subtitle:"FastAPI uptime",dataTour:"metric-health"}),(0,a.jsx)(u,{title:"Best Accuracy",value:(null===(r=f.data)||void 0===r?void 0:r.logreg_acc)?"".concat((100*f.data.logreg_acc).toFixed(1),"%"):"—",subtitle:"Latest churn model",dataTour:"metric-accuracy"}),(0,a.jsx)(u,{title:"Business Cost",value:(null===(m=f.data)||void 0===m?void 0:m.business_cost)?f.data.business_cost.toFixed(0):"—",subtitle:"Lower is better",dataTour:"metric-cost"}),(0,a.jsx)(u,{title:"Active Segments",value:x.data?"".concat(x.data.length):"—",subtitle:"Current persona clusters",dataTour:"metric-segments"})]}),(0,a.jsxs)("div",{className:"grid gap-4 lg:grid-cols-3",children:[(0,a.jsx)(y,{data:v,dataTour:"segment-distribution"}),(0,a.jsxs)(d.Zb,{className:"lg:col-span-2","data-tour":"latest-predictions",children:[(0,a.jsx)(d.ll,{children:"Latest Predictions"}),(0,a.jsx)(d.SZ,{children:"Track high-risk customers and high-value segments to trigger retention programs."}),(0,a.jsx)("div",{className:"mt-4 grid gap-3 md:grid-cols-2",children:[{label:"High-Risk Alerts",value:String(S.highRisk),icon:s.Z},{label:"High-Value Users",value:String(S.highValue),icon:o.Z},{label:"Active Predictions",value:String(S.total),icon:l.Z},{label:"Avg Churn",value:S.avgChurn.toFixed(2),icon:c.Z}].map(e=>{let t=e.icon;return(0,a.jsxs)("div",{className:"rounded-lg border border-panelBorder bg-background p-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("p",{className:"text-xs text-muted",children:e.label}),(0,a.jsx)(t,{size:16,className:"text-accent"})]}),(0,a.jsx)("p",{className:"mt-1 text-xl font-semibold",children:e.value})]},e.label)})})]})]})]})}},66070:function(e,t,r){"use strict";r.d(t,{SZ:function(){return o},Zb:function(){return i},ll:function(){return s}});var a=r(57437),n=r(94508);function i(e){let{className:t,...r}=e;return(0,a.jsx)("div",{className:(0,n.cn)("rounded-xl border border-panelBorder bg-panel p-4",t),...r})}function s(e){let{className:t,...r}=e;return(0,a.jsx)("h3",{className:(0,n.cn)("text-lg font-semibold",t),...r})}function o(e){let{className:t,...r}=e;return(0,a.jsx)("p",{className:(0,n.cn)("text-sm text-muted",t),...r})}},94508:function(e,t,r){"use strict";r.d(t,{cn:function(){return i}});var a=r(61994),n=r(53335);function i(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,n.m6)((0,a.W)(t))}},15883:function(e,t,r){"use strict";r.d(t,{h:function(){return s}});var a=r(40257);let n=function(){let e=a.env.NEXT_PUBLIC_API_BASE_URL;return e&&e.trim()?e.trim():"https://csr-vx85.onrender.com"}();async function i(e,t){let{auth:a}=await Promise.all([r.e(139),r.e(685),r.e(293)]).then(r.bind(r,17293)),i=a.currentUser,s=i?await i.getIdToken():null,o=null==i?void 0:i.uid,l=await fetch("".concat(n).concat(e),{headers:{"Content-Type":"application/json",...s?{Authorization:"Bearer ".concat(s)}:{},...o?{"X-Tenant-Id":o}:{}},...t});if(!l.ok)throw Error("API request failed: ".concat(l.status));return l.json()}let s={health:()=>i("/health"),predict:e=>i("/predict",{method:"POST",body:JSON.stringify(e)}),metrics:()=>i("/metrics"),segments:()=>i("/segments"),models:()=>i("/models"),modelDetail:e=>i("/models/".concat(e)),modelJson:e=>i("/models/".concat(e,"/json")),modelDataset:e=>i("/models/".concat(e,"/dataset")),defaultModel:()=>i("/models/default"),setDefaultModel:e=>i("/models/default",{method:"POST",body:JSON.stringify({model_id:e})}),predictions:()=>i("/predictions"),predictionDetail:e=>i("/predictions/".concat(e)),predictionDownload:e=>i("/predictions/".concat(e,"/download")),predictionCsv:async e=>{var t;let{auth:a}=await Promise.all([r.e(139),r.e(685),r.e(293)]).then(r.bind(r,17293));return fetch("".concat(n,"/predictions/").concat(e,"/csv"),{headers:{"Content-Type":"text/csv",...(null===(t=a.currentUser)||void 0===t?void 0:t.uid)?{"X-Tenant-Id":a.currentUser.uid}:{}}})},retrain:async e=>{let t=await fetch("/api/queue/train",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error("Failed to queue training");return t.json()},uploadDataset:async(e,t,r)=>{let a=new FormData;a.append("tenant_id",e),a.append("file",t),r&&a.append("mapping",JSON.stringify(r));let i=await fetch("".concat(n,"/upload"),{method:"POST",body:a});if(!i.ok)throw Error("Upload failed");return i.json()},queueSinglePrediction:async e=>{let t=await fetch("/api/queue/predict-single",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error(await t.text()||"Failed to queue single prediction");return t.json()},queueBatchPrediction:async e=>{let t=await fetch("/api/queue/predict-batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error("Failed to queue batch prediction");return t.json()}}}},function(e){e.O(0,[432,763,713,55,971,117,744],function(){return e(e.s=13436)}),_N_E=e.O()}]);